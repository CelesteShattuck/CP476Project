var data = {
    "easy":[
        {
            "Puzzle": "7..4..5.1......93....6.8.......1..67.4......3...86....31......96.9..3.7..7..9...5",
            "answer": "763429581284751936591638724925314867846972153137865492312587649659143278478296315"
        },
        {
            "Puzzle": ".........1.6...453924..........2...5...4..81.56.91......5....412.....6.889.1...3.",
            "answer": "753841296186279453924635187419328765372456819568917324635782941241593678897164532"
        },
        {
            "Puzzle": "5..8........3..86.4....6....752.1..6.2..6...31.4..7...7...43...24..5.1.7.....2...",
            "answer": "536829471912374865487516239375281946829465713164937528798143652243658197651792384"
        },
        {
            "Puzzle": ".....5.3.6.4...5......7.29.4........58..3..49....9.7.......36....7.....3.235.6..4",
            "answer": "792865431614329587358174296479651328586237149231498765945783612167942853823516974"
        },
        {
            "Puzzle": "........9...........4.89..6.2..7..6.6.....294.3..5.....8...59..2....3.5.5.74.238.",
            "answer": "863521479912647835754389126128974563675138294439256718386715942241893657597462381"
        },
        {
            "Puzzle": "......3.5..9..3.....5....2......2.1.......6...61..9...3..42.19..9...6.4.24.3...68",
            "answer": "624917385819253476735864921583642719972185634461739852356428197198576243247391568"
        },
        {
            "Puzzle": ".4.3..9...8.12.46.3...89.2........7.89.....3.4.....28..6.8....2..1.6........4....",
            "answer": "142376958789125463356489127623918574897254631415637289564893712931762845278541396"
        },
        {
            "Puzzle": "6........9.732...4........1...9..7.....7.849...2.6....8...76.2..1..8396.....9.1..",
            "answer": "621847539957321684438659271184932756563718492792564813849176325215483967376295148"
        },
        {
            "Puzzle": ".94........7....2.2....15.8........9....98.....95..21.....7.....261.5...54...6..1",
            "answer": "894652137157389426263741598675213849312498765489567213931874652726135984548926371"
        }
    ],
    "medium":[
        {
            "Puzzle": "3...8.....1.5..2..6.....1.4......81.14.3..5...3.8...62....4...7....2.3....4.7....",
            "answer": "352481796417596238689237154296754813148362579735819462863145927971628345524973681"
        },
        {
            "Puzzle": "..5..4....1.87......419..2......1....7968......2.4....4.....9...9...7..2.5....861",
            "answer": "985234617216875349734196528843751296579682134162943785421568973698317452357429861"
        },
        {
            "Puzzle": ".48...63..........7.6..3285....2.4..5.........74...36...5..4.2.98...2.7.....9....",
            "answer": "248579631351268749796143285139826457562437198874951362615784923983612574427395816"
        },
        {
            "Puzzle": "......9....38.7....6.....81..8...3.6...96....1......47.8963..7...1..963.....5.1..",
            "answer": "847216953513897264962543781428175396375964812196382547289631475751429638634758129"
        },        {
            "Puzzle": "15..8....9...17.....35.....8.5.....43.....8..7....4.35.1.74..2.4...92.....8..1...",
            "answer": "154283769986417352273569148895136274342975816761824935519748623437692581628351497"
        },
        {
            "Puzzle": "..98..............28...6547.5436....8..4......935..2.....6..783.....49.2....9..6.",
            "answer": "739845126465127398281936547154362879827419635693578214942651783316784952578293461"
        },
        {
            "Puzzle": "6......1.3.....648.........8.....4.6....72.8........7..1..67.2..64.3......2185...",
            "answer": "649358217375921648281746539827513496493672185156894372518467923764239851932185764"
        },
        {
            "Puzzle": "....7.....1.9.265..2........5.64...8..4..9.....2.8.9....9....76.6....829..7...1..",
            "answer": "396571482418932657725468391951647238834129765672385914249813576163754829587296143"
        }
    ],
    "hard": [
        {
            "Puzzle": "......4.9..6...3...9.26..5..2......5....9..1..5...3......4.813..41.25.8.........4",
            "answer": "512837469876954321394261758123746895487592613659183247965478132741325986238619574"
        },
        {
            "Puzzle": ".8.63..4.65..7.1..1..2..8.7.1.........5..2..3..6..7....78........28.3..143.......",
            "answer": "287631549654978132193254867319485276745162983826397415978516324562843791431729658"
        },
        {
            "Puzzle": "..3......4.......7....9.4.....1..8...7..89..2...64..3.3.....2.48..26..7316.......",
            "answer": "523471689498526317716893425234157896671389542985642731357918264849265173162734958"
        },
        {
            "Puzzle": ".......8...7.84......2..9.7....2...9.8..374...428.5..........4..24.5637....7....5",
            "answer": "213579684697184523458263917765421839981637452342895761579318246124956378836742195"
        },        {
            "Puzzle": "2....9..874.....1.8..1..73.48.2..1.........4...74.895.......3.5.9...5.........4..",
            "answer": "213749568746583219859162734485296173921357846637418952178624395394875621562931487"
        },
        {
            "Puzzle": "......4...9.6.1..851..3.........9......54..83..2....5......812....96....6..3.2.4.",
            "answer": "326895417794621538518437692435289761179546283862173954943758126281964375657312849"
        },
        {
            "Puzzle": "..68....78..54.....4...1....8.....9...4..82.51.2..9.6..............521.871.......",
            "answer": "526893417891547623347261589683425791974618235152739864238174956469352178715986342"
        },
        {
            "Puzzle": "...9..65.....7..2.9....4...2..5....48..2.3.7...578.....2....89.43...........5...2",
            "answer": "714928653368175429952364718273516984891243576645789231526431897437892165189657342"
        }
    ],
    "test": [
        {
            "Puzzle": "......111111111111111111111111111111111111111111111111111111111111111111111111111",
            "answer": "111111111111111111111111111111111111111111111111111111111111111111111111111111111"
        }
    ]
};
//Create variables
var timer;
var timeRemaining;
var lives;
var selectedNum;
var selectedTile;
var disableSelect;

var randomNum //selected puzzle
var solution

window.onload = function(){
    //Run startgame function when button is clicked
    id("offline-btn").addEventListener("click", startGame);
    //Add event listener to each number in number containers
    for (let i = 0; i < id("number-container").children.length; i++){
        id("number-container").children[i].addEventListener("click", function(){
            //If selecting is not disabled
            if (!disableSelect){
                //If number is already selected, select
                if (this.classList.contains("selected")){
                    //Then remove selection
                    this.classList.remove("selected");
                    selectedNum = null;
                } else{
                    //Deselect all other numbers
                    for (let i = 0; i < 9; i++){
                        id("number-container").children[i].classList.remove("selected");
                    }
                    //Select it and update selectedNum variables
                    this.classList.add("selected");
                    selectedNum = this;
                    updateMove();
                }
            }
        });
    }
}

function startGame(){
    //Choose board difficulty
    let board;
    randomNum = Math.floor(Math.random() * 7); //randomly select a puzzle 8 for puzzle amount
    if (id("diff-1").checked){
        board = data.easy[randomNum].Puzzle;
        solution = data.easy[randomNum].answer;
    }
    else if (id("diff-2").checked){
        board = data.medium[randomNum].Puzzle;
        solution = data.medium[randomNum].answer;
    }
    else if (id("diff-4").checked){
        board = data.test[0].Puzzle;
        solution = data.test[0].answer;
    }
    else{
         board = data.hard[randomNum].Puzzle;
         solution = data.hard[randomNum].answer;
    }
    //Set lives to 3 and enable selecting numbers and tiles
    lives = 3;
    disableSelect = false;
    id("lives").textContent = "Lives Remaining: 3";
    //Creates board based on difficulty
    generateBoard(board);
    //Starts the timer 
    startTimer();
    //Show number containers
    id("number-container").classList.remove("hidden");
}

function startTimer(){
    //Sets time remaining based on imput
    if (id("time-1").checked) timeRemaining = 180;
    else if (id("time-2").checked) timeRemaining = 300;
    else timeRemaining = 600;
    //Sets timer for first seconds
    id("timer").textContent = timeConversion(timeRemaining);
    //Set timer to update every seconds
    timer = setInterval(function(){
        timeRemaining --;
        if (timeRemaining === 0) endGame();
        id("timer").textContent = timeConversion(timeRemaining);
    }, 1000)
}

//Converts seconds into string of MM:SS format
function timeConversion(time){
    let minutes = Math.floor(time/60);
    if (minutes < 10) minutes = "0" + minutes;
    let seconds = time % 60;
    if (seconds < 10) seconds = "0" + seconds;
    return minutes + ":" + seconds;

}

function generateBoard(board){
    //Clear previous board
    clearPrevious();
    //Let used to increment tile ids
    let idCount = 0;
    //Create 81 tiles
    for (let i = 0; i < 81; i++){
        let tile = document.createElement("p");
        //If the tiles is not blank
        if (board.charAt(i) != "."){
            //Set tile text to correct numbers
            tile.textContent = board.charAt(i);
        } else {
            //Add click event listener to tile
            tile.addEventListener("click", function() {
                //If selecting is not disabled
                if (!disableSelect){
                    //If the tile is already selected
                    if (tile.classList.contains("selected")){
                        //Then remove selection
                        tile.classList.remove("selected");
                        selectedTile = null;
                    } else {
                        //Deselect all other tiles
                        for (let i = 0; i < 81; i++){
                            qsa(".tile")[i].classList.remove("selected");
                        }
                        //Add selection and update variable
                        tile.classList.add("selected");
                        selectedTile = tile;
                        updateMove();
                    }
                }
            });
        }
        //Assign tile id
        tile.id = idCount;
        //Increment for next tiles
        idCount ++;
        //Add tile class to all tiles
        tile.classList.add("tile");
        if ((tile.id > 17 && tile.id < 27) || (tile.id > 44 & tile.id < 54)){
            tile.classList.add("bottomBorder");
        }
        if ((tile.id + 1) % 9 == 3 || (tile.id + 1) % 9 == 6){
            tile.classList.add("rightBorder");
        }
        //Add tile to board
        id("board").appendChild(tile);
    }
}

function updateMove() {
    //if a tile and a number is selected
    if (selectedTile && selectedNum) {
        //Set the tile to the correct numbers
        selectedTile.textContent = selectedNum.textContent;
        //If the number matches the corresponding number in the solution key
        if (checkCorrect(selectedTile)){
            //Deselects the tile
            selectedTile.classList.remove("selected");
            selectedNum.classList.remove("selected");
            //clear the selected variables 
            selectedNum = null;
            selectedTile = null;
            //Check if board is completed
            if (checkDone()){
                endGame();
            }
            //If the number does not match the solution key 
        }else {
            //Disable selecting new numbers for one second
            disableSelect = true;
            //Make the tile turn red
            selectedTile.classList.add("incorrect");
            //Run in one second 
            setTimeout(function(){
                //Subtract
                lives --;
                //If no lives left end the game
                if (lives === 0){
                    endGame();
                }else {
                    //If lives is not equal to zero 
                    //Update lives text
                    id("lives").textContent = "Lives Remaining: "+ lives;
                    //Renable selecting numbers and tiles
                    disableSelect = false;
                }
                //Restore tile color and remove selected from both
                selectedTile.classList.remove("incorrect");
                selectedTile.classList.remove("selected");
                selectedNum.classList.remove("selected");
                //Clear the tiles text and clear selected variables
                selectedTile.textContent = "";
                selectedTile = null;
                selectedNum = null;
            }, 500);
        }
    }
}

function checkDone() {
    let tiles = qsa(".tile");
    for (let i = 0; i < tiles.length; i++){
        if (tiles[i].textContent === "") return false;
    }
    return true;
}

function endGame(){
    //Disable moves and stop the timer
    disableSelect = true;
    clearTimeout(timer);
    //Display winor loss message
    if (lives === 0 || timeRemaining === 0){
        id("lives").textContent = "You Lost!";
    } else{
        id("lives").textContent = "You Won!";
    }
}

function checkCorrect(tile){
    //Set solution based on difficulty selection 
    //we have answer stored already
    if (solution.charAt(tile.id) === tile.textContent) return true;
    else return false;
}

function clearPrevious(){
    //Access all of the tiles
    let tiles = qsa(".tile");
    for (let i = 0; i < tiles.length; i++){
        tiles[i].remove();
    }
    //If there is a timer clear interface
    if (timer) clearTimeout(timer);
    //Deselect any numbers
    for (let i = 0; i < id("number-container").children.length; i++){
        id("number-container").children[i].classList.remove("selected");
    }
    //Clear selected variables
    selectedTile = null;
    selectedNum = null;
}
//Helper fuctions
function id(id){
    return document.getElementById(id);
}
function qs(selector){
    return document.querySelector(selector);
}
function qsa(selector){
    return document.querySelectorAll(selector);
}

